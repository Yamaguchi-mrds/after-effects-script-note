# **TOTP / HOTP One-Time Password Notes

### A simple way to explain TOTP

AfterEffectのUXPを見越してセキュリティの勉強もしています。

DBシステムを作るにあたってセキュリティに関する知識は厚めにしておきたいですね。その流れでワンタイムパスワードについて勉強したのでログとして残します。

⏱ワンタイムパスワードをめっちゃ簡単に説明すると・・・
・作戦行動で「お互いのストップウォッチを同時に走らすぞ ！
　せーの！ポン！」→ 秘密鍵の発行
・別々の作戦を実行中 → 同じルールで時間経過をお互いカウント中
・再会したときに 「お前本物か？！偽物か！？今のストップウォッチの数字を言ってみろ！ 」→ 照合（一致チェック）
 → そこでガチッと合えば・・・「お前は本物だ！」
 → そこでガチッと合わなければ・・・「お前は偽物だ！誰だ！？」

っていう仕組みだそうです。以下、詳細を整理

# ■ワンタイムパスワード（TOTP/HOTP）について

---
ポイント

- 時刻同期の仕組み
    
- 秘密鍵の役割
    
- サーバーとスマホの同期
    
- 計算式の実体（ステップ×HMAC）
    
- 漏洩ポイント
    
- 強度の理由
    
- TOTPとHOTPの役割
    
- 公開仕様なのに安全な理由
    
- 実装の流れ（QRコード → 鍵共有 → 計算 → 照合）
- 
---
# 1. 採用可能なワンタイムパス方式

### ●TOTP（Time-based One-Time Password）

- 30秒ごとに更新されるワンタイムパス
    
- 現代の認証で最も一般的
    
- Google Authenticatorなどが採用
    
- 今回の検討対象の中心
    

### ●HOTP（Counter-based One-Time Password）

- カウンター（回数）で更新
    
- 現代ではあまり使われない
    
- 旧来のハードウェア認証方式で利用されることが多い
    

### ●どちらも RFC（公開仕様）として定義済み

- 誰でも実装可能
    
- ライブラリを入れるだけで利用可能
    
- 実装コストが非常に低い
    

---

# 2. 実装方法

### ●利用するのは「公開アルゴリズム」

- サーバーは TOTP/HOTP の計算ロジックを持つ
    
- ライブラリとして提供されているので組み込めば即利用可
    
- Authenticator(オーセンティケーター)・・・Google が提供しているのは“便利アプリ”であって“本体”ではない
    

### ●秘密鍵の生成（最重要ポイント）

- サーバー側が各ユーザーの秘密鍵（ランダム）を生成
    
- 秘密鍵はサーバーと端末の両方が保持
    
- 以降は両者がこの鍵を使って独立にワンタイムパスを計算する
    

---

# 3. スマホ側（Authenticator）の役割

### ●やっていることはシンプル

1. 秘密鍵を安全領域に保持
    
2. UNIX時間を参照
    
3. 「時間 ÷ 30秒」でステップ番号を算出
    
4. 秘密鍵＋ステップでHMACを計算
    
5. 6桁のTOTPを表示
    

### ●人間が触るのは“表示された6桁だけ”

- 秘密鍵には一切触れない
    
- OS の保護領域に保存される
    
- 原則として漏洩しない構造
    

---

# 4. サーバー側の動き

### ●サーバーは計算を“必要な時だけ”行う

1. ユーザーがログイン（TOTP入力）
    
2. サーバーは自分の時計を見る
    
3. 「時間 ÷ 30」でステップ番号を算出
    
4. システムに保存してある秘密鍵と組み合わせて計算
    
5. 一致すれば認証OK
    

### ●重要点

- サーバーは常に計算し続けない
    
- リクエストが来た時だけ数字を1回生成する
    
- 負荷はほぼゼロ
    

---

# 5. 時間同期について

### ●世界の基準：UTC（協定世界時）

- 電波時計、スマホ、サーバーはすべてこの時間に収束
    
- UNIX時間は「UTC を秒数に変換した表現」
    

### ●スマホ

- オフラインでも内部時計で動作
    
- NTP・キャリア電波で定期的に補正
    
- 数秒レベルのズレなら許容可能
    

### ●サーバー

- 24時間 NTP と同期
    
- ほぼ誤差ゼロ
    
- 本番環境では必ず精密同期される
    

### ●ズレの許容

- 実際には ±30秒前後までは許容
    
- TOTP の30秒周期との相性が良く、実運用に最適
    

---

# 6. セキュリティの本質

### ●強さの源泉：秘密鍵の保護

- 秘密鍵が漏れるとアウト
    
- 逆に秘密鍵さえ守られれば破られない
    
- スマホ → Secure Storage
    
- サーバー → DBの暗号化領域に保存
    

### ●人間が秘密鍵に触れない構造

- QRコード登録時以外は可視化されない
    
- 盗みようがほぼ存在しない
    

### ●攻撃可能性

- 鍵を盗めるとしたら不正アプリくらい
    
- ただし正規のAuthenticatorであれば実質ゼロ
    
- 通信経路上で鍵が漏れることもない（鍵自体は送らない）
    

---

# 7. 導入のメリット

- 無料で実装できる
    
- 公開仕様なので信頼性が高い
    
- 金融系も使う堅牢性
    
- 自前サーバーに完全に組み込める
    
- デバイス数が増えても負荷ほぼゼロ
    
- 開発者のスキルアピールにも最適
    

---

# ■最終まとめ（あなたの理解のポイントだけ抽出）

- TOTP/HOTP は RFC による公開仕様
    
- 秘密鍵をサーバーが発行し、端末と共有
    
- 両者は UTC（UNIX時間）を参照して計算
    
- 30秒周期は人間と機械のズレを吸収した最適値
    
- 秘密鍵が漏れなければ破られない
    
- アプリは暗号計算して6桁を出すだけのシンプル構造
    
- ズレは ±30秒ほどまで許容できる
    
- 導入コストはほぼゼロ
    
