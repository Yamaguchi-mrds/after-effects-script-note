# After Effects ScriptUI パネルとスクリプト実行モードの挙動整理

## パネル生成のタイミング

ScriptUI パネルは After Effects の **ウィンドウメニューから開いた瞬間にスクリプトが読み込まれる**。
AE を再起動しなくても、パネルを閉じて再度開くとスクリプトが再ロードされる。
この仕組みにより、開発中でもパネルを閉じて再度開くだけで最新のスクリプトを反映できる。

## ターゲットエンジンによるメモリ共有

`#targetengine` を指定すると、その名前を持つエンジンに変数や関数が保持される。

* 同じエンジン名で呼び出せば、複数回の実行でも変数が共有される。
* エンジンを指定しない場合、呼び出すたびに新しいメモリ空間が生成される。
* AE を終了すればエンジンは破棄され、変数もリセットされる。

この仕様により、UI 状態やフラグを複数回の呼び出しで保持できる一方、変数名を変更した場合などは古い変数が残る場合がある。開発中に挙動が不安定なときは AE を再起動すれば解決する。

## パネルモードとスクリプトモードのUI処理

UI の構築は **パネルモード**と**スクリプト実行モード**で処理が異なる。

* **パネルモード**

  * AE が生成した Panel オブジェクト (`this`) を利用する。
  * UI 要素を追加した後に `win.layout.layout(true)` を呼び、レイアウトを再計算する必要がある。
  * `win.show()` は不要。

* **スクリプト実行モード**

  * 自分で `new Window("dialog" …)` などを作成する。
  * `win.show()` を呼び出すことで表示され、初期レイアウトも自動で行われる。

この2つを適切に分岐させることで、スクリプトとしてもパネルとしても動作する UI を実現できる。

## 判定方法とフラグ管理

モード判定には `thisObj instanceof Panel` を用いる。
これをフラグ化して `isPanelMode` として管理することで処理の流れを整理できる。

例：

```jsx
var isPanelMode = (thisObj instanceof Panel);
var win = isPanelMode ? thisObj : new Window("dialog", "OneEase_v2");

// UI 構築処理 …

if (isPanelMode) {
    win.layout.layout(true);
} else {
    win.show();
}
```

* 判定を1回だけにまとめ、冒頭でフラグを作る
* 最後の処理で `isPanelMode` を参照して `layout` と `show` を切り替える
* このパターンであれば処理が明確になり、パネル／スクリプト両対応が容易になる

---

## まとめ

1. パネルは「開いた瞬間にスクリプトを読み込む」。閉じて開き直すだけで再ロード可能。
2. `#targetengine` を指定すれば変数や状態を保持できるが、ゴミが残る場合は AE 再起動でリセット。
3. パネルモードでは `layout.layout(true)`、スクリプトモードでは `win.show()` を使い分ける。
4. `isPanelMode` フラグで判定を整理すれば、両モード対応の実装が分かりやすくなる。


